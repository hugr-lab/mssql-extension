# DDL Contracts: CTAS for MSSQL

**Branch**: `022-mssql-ctas` | **Date**: 2026-01-28

This document defines the T-SQL DDL statements generated by CTAS and the expected responses.

---

## Contract 1: CREATE TABLE

**Generator**: `MSSQLDDLTranslator::TranslateCreateTableFromSchema()`

**Input**:
- Schema name (string)
- Table name (string)
- Column definitions (vector<CTASColumnDef>)

**Output Template**:
```sql
CREATE TABLE [<schema>].[<table>] (
    [<column1>] <type1> [NULL|NOT NULL],
    [<column2>] <type2> [NULL|NOT NULL],
    ...
);
```

**Example**:
```sql
-- DuckDB: CREATE TABLE mssql.dbo.orders AS SELECT 1 AS id, 'test' AS name, 3.14 AS price
CREATE TABLE [dbo].[orders] (
    [id] int NOT NULL,
    [name] nvarchar(max) NULL,
    [price] float NOT NULL
);
```

**Expected Response**:
- Success: DONE token with `rows_affected = 0`
- Failure: ERROR token with error number and message

**Error Conditions**:
| Error Number | Message Pattern | Meaning |
|--------------|-----------------|---------|
| 2714 | "There is already an object named '...' in the database" | Table exists |
| 208 | "Invalid object name '...'" | Schema does not exist |
| 1038 | "An object or column name is missing or empty" | Empty column name |

---

## Contract 2: DROP TABLE (for OR REPLACE)

**Generator**: `MSSQLDDLTranslator::TranslateDropTable()`

**Input**:
- Schema name (string)
- Table name (string)

**Output Template**:
```sql
DROP TABLE [<schema>].[<table>];
```

**Example**:
```sql
DROP TABLE [dbo].[orders];
```

**Expected Response**:
- Success: DONE token with `rows_affected = 0`
- Failure: ERROR token

**Error Conditions**:
| Error Number | Message Pattern | Meaning |
|--------------|-----------------|---------|
| 3701 | "Cannot drop the table '...', because it does not exist" | Table not found |
| 3726 | "Could not drop object '...' because it is referenced by a FOREIGN KEY constraint" | FK constraint |

---

## Contract 3: Table Existence Check

**Generator**: `MSSQLSimpleQuery::ExecuteScalar()`

**Query**:
```sql
SELECT CASE WHEN EXISTS (
    SELECT 1 FROM sys.objects
    WHERE object_id = OBJECT_ID(N'[<schema>].[<table>]')
    AND type = 'U'
) THEN 1 ELSE 0 END;
```

**Expected Response**:
- `"1"` — Table exists
- `"0"` — Table does not exist

---

## Contract 4: Schema Existence Check

**Generator**: `MSSQLSimpleQuery::ExecuteScalar()`

**Query**:
```sql
SELECT CASE WHEN EXISTS (
    SELECT 1 FROM sys.schemas WHERE name = N'<schema>'
) THEN 1 ELSE 0 END;
```

**Expected Response**:
- `"1"` — Schema exists
- `"0"` — Schema does not exist

---

## Contract 5: Batched INSERT (from existing INSERT path)

**Generator**: `MSSQLInsertStatement::Generate()`

**Output Template**:
```sql
INSERT INTO [<schema>].[<table>] ([col1], [col2], ...)
VALUES
    (<val1>, <val2>, ...),
    (<val1>, <val2>, ...),
    ...;
```

**Value Encoding**:
| DuckDB Type | SQL Literal Format |
|-------------|-------------------|
| NULL | `NULL` |
| BOOLEAN | `0` or `1` |
| INTEGER types | Numeric literal |
| FLOAT/DOUBLE | Numeric literal (scientific notation for extremes) |
| VARCHAR | `N'<escaped>'` (Unicode literal) |
| BLOB | `0x<hex>` |
| DATE | `'YYYY-MM-DD'` |
| TIME | `'HH:MM:SS.nnnnnnn'` |
| TIMESTAMP | `'YYYY-MM-DD HH:MM:SS.nnnnnnn'` |
| TIMESTAMP_TZ | `'YYYY-MM-DD HH:MM:SS.nnnnnnn +HH:MM'` |
| UUID | `'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'` |
| DECIMAL | Numeric literal with full precision |

**String Escaping**: `'` → `''`

**Batch Size Limits**:
- Max rows per statement: `mssql_insert_max_rows_per_statement` (default 1000)
- Max SQL bytes: `mssql_insert_max_sql_bytes` (default 8MB)

**Expected Response**:
- Success: DONE token with `rows_affected = <batch_size>`
- Failure: ERROR token

---

## Error Response Contract

All DDL errors return TDS ERROR tokens with:

```cpp
struct TdsError {
    uint32_t error_number;    // SQL Server error code
    uint8_t state;            // Error state
    uint8_t severity;         // Severity level (16+ = error)
    string message;           // Human-readable message
    string server_name;       // Server that generated error
    string procedure_name;    // Procedure name (empty for ad-hoc)
    uint32_t line_number;     // Line in batch
};
```

**Error Handling**:
1. Parse ERROR token from TDS response
2. Map to appropriate DuckDB exception type
3. Include original SQL Server message for debugging
