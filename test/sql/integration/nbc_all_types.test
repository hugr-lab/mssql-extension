# name: test/sql/integration/nbc_all_types.test
# description: Verify all supported data types work correctly in NBCROW encoding
# group: [integration]

require mssql

require-env MSSQL_TESTDB_DSN

statement ok
SET mssql_connection_cache=false;

statement ok
ATTACH '${MSSQL_TESTDB_DSN}' AS nbc_all (TYPE mssql);

# =============================================================================
# Setup: Create table with ALL supported types, all nullable + padding for NBCROW
# =============================================================================

statement ok
SELECT mssql_exec('nbc_all', '
IF OBJECT_ID(''dbo.TestNbcAllTypes'', ''U'') IS NOT NULL DROP TABLE dbo.TestNbcAllTypes;
CREATE TABLE dbo.TestNbcAllTypes (
    id INT NOT NULL PRIMARY KEY,
    col_tinyint TINYINT NULL,
    col_smallint SMALLINT NULL,
    col_int INT NULL,
    col_bigint BIGINT NULL,
    col_bit BIT NULL,
    col_real REAL NULL,
    col_float FLOAT NULL,
    col_smallmoney SMALLMONEY NULL,
    col_money MONEY NULL,
    col_decimal DECIMAL(18,6) NULL,
    col_numeric NUMERIC(10,2) NULL,
    col_uniqueidentifier UNIQUEIDENTIFIER NULL,
    col_char CHAR(10) NULL,
    col_varchar VARCHAR(100) NULL,
    col_nchar NCHAR(10) NULL,
    col_nvarchar NVARCHAR(100) NULL,
    col_binary BINARY(4) NULL,
    col_varbinary VARBINARY(100) NULL,
    col_date DATE NULL,
    col_time TIME NULL,
    col_datetime DATETIME NULL,
    col_datetime2 DATETIME2 NULL,
    col_smalldatetime SMALLDATETIME NULL,
    col_datetimeoffset DATETIMEOFFSET NULL
);
INSERT INTO dbo.TestNbcAllTypes VALUES
    (1, 255, 32767, 2147483647, 9223372036854775807, 1, 3.14, 2.718281828,
     214748.3647, 922337203685477.5807, 123456.789012, 12345678.90,
     ''12345678-1234-1234-1234-123456789ABC'',
     ''CHAR_VAL  '', ''varchar val'', N''NCHAR     '', N''nvarchar val'',
     0xDEADBEEF, 0xCAFE,
     ''2024-06-15'', ''13:45:30.1234567'', ''2024-06-15 13:45:30.123'',
     ''2024-06-15 13:45:30.1234567'', ''2024-06-15 13:45:00'',
     ''2024-06-15 13:45:30.1234567 +05:30'');
INSERT INTO dbo.TestNbcAllTypes (id) VALUES (2);
');

statement ok
SELECT mssql_refresh_cache('nbc_all');

# =============================================================================
# Test 1: All non-null values read correctly via NBCROW
# =============================================================================

# Integer types
query IIIII
SELECT col_tinyint, col_smallint, col_int, col_bigint, col_bit FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 1;
----
255	32767	2147483647	9223372036854775807	true

# Float types
query III
SELECT col_smallmoney, col_money, col_decimal FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 1;
----
214748.3647	922337203685477.5807	123456.789012

# String types
query IIII
SELECT col_char, col_varchar, col_nchar, col_nvarchar FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 1;
----
CHAR_VAL  	varchar val	NCHAR	nvarchar val

# Date/Time types
query IIIII
SELECT col_date, col_time, col_datetime2, col_smalldatetime, col_datetimeoffset FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 1;
----
2024-06-15	13:45:30.123456	2024-06-15 13:45:30.123456	2024-06-15 13:45:00	2024-06-15 08:15:30.123456+00

# =============================================================================
# Test 2: All-NULL row via NBCROW
# =============================================================================

query IIIIIIIII
SELECT col_tinyint, col_smallint, col_int, col_bigint, col_bit, col_real, col_float, col_date, col_datetimeoffset FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 2;
----
NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL

query IIII
SELECT col_char, col_varchar, col_nchar, col_nvarchar FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 2;
----
NULL	NULL	NULL	NULL

query IIIII
SELECT col_date, col_time, col_datetime2, col_smalldatetime, col_datetimeoffset FROM nbc_all.dbo.TestNbcAllTypes WHERE id = 2;
----
NULL	NULL	NULL	NULL	NULL

# =============================================================================
# Cleanup
# =============================================================================

statement ok
SELECT mssql_exec('nbc_all', 'DROP TABLE IF EXISTS dbo.TestNbcAllTypes;');

statement ok
DETACH nbc_all;
