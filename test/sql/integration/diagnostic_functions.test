# name: test/sql/integration/diagnostic_functions.test
# description: Integration tests for mssql_open, mssql_close, mssql_ping diagnostic functions
# group: [integration]
#
# These tests verify the diagnostic functions work correctly with a real SQL Server.
# mssql_open accepts connection strings (ADO.NET or URI format) or secret names.

require mssql

require-env MSSQL_TEST_DSN

# Test 1: mssql_open with connection string - should succeed and return a connection handle
# Store handle in temp table for use in subsequent tests
statement ok
CREATE TEMP TABLE test_handle AS SELECT mssql_open('${MSSQL_TEST_DSN}') AS handle;

query I
SELECT handle >= 1 FROM test_handle;
----
true

# Test 2: mssql_ping - verify connection is alive
query I
SELECT mssql_ping((SELECT handle FROM test_handle));
----
true

# Test 3: mssql_close the opened connection
query I
SELECT mssql_close((SELECT handle FROM test_handle));
----
true

# Cleanup temp table
statement ok
DROP TABLE test_handle;

# Test 4: mssql_close with invalid handle should be idempotent (return true)
query I
SELECT mssql_close(99999);
----
true

# Test 5: mssql_ping with invalid handle should fail gracefully
statement error
SELECT mssql_ping(99999);
----
Invalid connection handle

# Test 6: mssql_open with non-existent secret should fail
statement error
SELECT mssql_open('nonexistent_secret');
----
not found

# Test 7: Connection to unreachable host should timeout/fail
statement error
SELECT mssql_open('Server=192.0.2.1,1433;Database=TestDB;User Id=test;Password=test');
----
connect
