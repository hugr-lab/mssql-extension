# name: test/sql/integration/connection_pool.test
# description: Integration tests for connection pooling with ATTACH
# group: [integration]
#
# REQUIRES: SQL Server running on localhost:1433 with SA password 'DevPassword123!'
# Run with: make integration-test

require mssql

# Create a secret for testing
statement ok
CREATE SECRET pool_test_secret (
    TYPE mssql,
    host 'localhost',
    port 1433,
    database 'TestDB',
    user 'sa',
    password 'DevPassword123!'
);

# Test 1: ATTACH creates a connection pool
statement ok
ATTACH '' AS testdb (TYPE mssql, SECRET pool_test_secret);

# Test 2: Pool statistics should be available for attached database
query IIIIIIII
SELECT
    db = 'testdb',
    total_connections >= 0,
    idle_connections >= 0,
    active_connections >= 0,
    connections_created >= 0,
    connections_closed >= 0,
    acquire_count >= 0,
    acquire_timeout_count >= 0
FROM mssql_pool_stats(context_name='testdb');
----
true	true	true	true	true	true	true	true

# Test 3: Pool statistics for non-existent context should return empty
query I
SELECT count(*) FROM mssql_pool_stats(context_name='nonexistent_context');
----
0

# Test 4: Pool statistics without parameter returns all pools
query I
SELECT count(*) >= 1 FROM mssql_pool_stats();
----
true

# Test 5: Configure pool settings
statement ok
SET mssql_connection_limit = 5;

query I
SELECT current_setting('mssql_connection_limit');
----
5

# Test 6: Detach should cleanup the pool
statement ok
DETACH testdb;

# Test 7: After detach, pool stats should return empty
query I
SELECT count(*) FROM mssql_pool_stats(context_name='testdb');
----
0

# Test 8: Re-attach with connection string
statement ok
ATTACH 'Server=localhost,1433;Database=TestDB;User Id=sa;Password=DevPassword123!' AS testdb2 (TYPE mssql);

# Pool should be created for connection string attachment too
query I
SELECT total_connections >= 0 FROM mssql_pool_stats(context_name='testdb2');
----
true

statement ok
DETACH testdb2;

# Cleanup
statement ok
DROP SECRET pool_test_secret;

# Reset settings
statement ok
SET mssql_connection_limit = 64;
