# name: test/sql/integration/connection_pool.test
# description: Integration tests for connection pooling with ATTACH
# group: [integration]
#
# REQUIRES: SQL Server running on localhost:1433
# Run with: make integration-test

require mssql

require-env MSSQL_TEST_DSN

# Test 1: ATTACH creates a connection pool
statement ok
ATTACH '${MSSQL_TEST_DSN}' AS pool_db (TYPE mssql);

# Test 2: Pool statistics should be available for attached database
query IIIIIIII
SELECT
    db = 'pool_db',
    total_connections >= 0,
    idle_connections >= 0,
    active_connections >= 0,
    connections_created >= 0,
    connections_closed >= 0,
    acquire_count >= 0,
    acquire_timeout_count >= 0
FROM mssql_pool_stats(context_name='pool_db');
----
true	true	true	true	true	true	true	true

# Test 3: Pool statistics for non-existent context should return empty
query I
SELECT count(*) FROM mssql_pool_stats(context_name='nonexistent_context');
----
0

# Test 4: Pool statistics without parameter returns all pools
query I
SELECT count(*) >= 1 FROM mssql_pool_stats();
----
true

# Test 5: Configure pool settings
statement ok
SET mssql_connection_limit = 5;

query I
SELECT current_setting('mssql_connection_limit');
----
5

# Test 6: Detach should cleanup the pool
statement ok
DETACH pool_db;

# Test 7: After detach, pool stats should return empty
query I
SELECT count(*) FROM mssql_pool_stats(context_name='pool_db');
----
0

# Test 8: Re-attach with connection string
statement ok
ATTACH '${MSSQL_TEST_DSN}' AS pool_db2 (TYPE mssql);

# Pool should be created for connection string attachment too
query I
SELECT total_connections >= 0 FROM mssql_pool_stats(context_name='pool_db2');
----
true

statement ok
DETACH pool_db2;

# Reset settings
statement ok
SET mssql_connection_limit = 64;
