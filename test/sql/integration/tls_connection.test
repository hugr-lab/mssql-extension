# name: test/sql/integration/tls_connection.test
# description: Integration tests for TLS/encrypted connections to MSSQL
# group: [integration]
#
# REQUIRES: SQL Server running on localhost:1433 with TLS support
# SQL Server 2022 has TLS enabled by default with self-signed certificate.
#
# Setup:
#   docker compose -f docker/docker-compose.yml up -d
#   export MSSQL_TEST_DSN="mssql://sa:TestPassword1@localhost:1433/master"
#   export MSSQL_TEST_DSN_TLS="mssql://sa:TestPassword1@localhost:1433/master?encrypt=true"
#
# Run with: make integration-test

require mssql

require-env MSSQL_TEST_DSN_TLS

# ============================================================================
# Test: Basic TLS Connection
# Verifies that a TLS connection can be established and used for queries
# ============================================================================
statement ok
ATTACH '${MSSQL_TEST_DSN_TLS}' AS tls_db (TYPE mssql);

# Simple query over TLS
query I
SELECT * FROM mssql_scan('tls_db', 'SELECT 1 AS test_value');
----
1

# Verify connection is working with multiple columns
query II
SELECT * FROM mssql_scan('tls_db', 'SELECT 42 AS answer, 123 AS number');
----
42	123

# String data over TLS
query I
SELECT * FROM mssql_scan('tls_db', 'SELECT ''Hello TLS'' AS greeting');
----
Hello TLS

# Cleanup
statement ok
DETACH tls_db;

# ============================================================================
# Test: TLS Connection Pool Statistics
# Verifies that TLS connections are tracked correctly in pool
# ============================================================================
statement ok
ATTACH '${MSSQL_TEST_DSN_TLS}' AS tls_pool_db (TYPE mssql);

# Execute a query to ensure connection is established
query I
SELECT * FROM mssql_scan('tls_pool_db', 'SELECT 1 AS val');
----
1

# Check pool statistics - connection should be created
query I
SELECT connections_created >= 1 FROM mssql_pool_stats('tls_pool_db');
----
true

# Execute multiple queries and verify connection reuse
query I
SELECT * FROM mssql_scan('tls_pool_db', 'SELECT 2 AS val');
----
2

query I
SELECT * FROM mssql_scan('tls_pool_db', 'SELECT 3 AS val');
----
3

# Cleanup
statement ok
DETACH tls_pool_db;

# ============================================================================
# Test: Large Data Transfer Over TLS
# Verifies that TLS can handle larger data transfers
# ============================================================================
statement ok
ATTACH '${MSSQL_TEST_DSN_TLS}' AS tls_large_db (TYPE mssql);

# Query that returns multiple rows
query I
SELECT COUNT(*) FROM mssql_scan('tls_large_db', 'SELECT TOP 100 ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) AS n FROM sys.objects');
----
100

# Query with string data
query I
SELECT LENGTH(val) > 50 FROM mssql_scan('tls_large_db', 'SELECT REPLICATE(''X'', 100) AS val');
----
true

# Cleanup
statement ok
DETACH tls_large_db;

# ============================================================================
# Test: TLS Secret Creation with use_encrypt parameter
# Verifies that secrets can be created with encryption option
# ============================================================================
statement ok
CREATE SECRET tls_test_secret (
    TYPE mssql,
    host 'localhost',
    port 1433,
    database 'master',
    user 'sa',
    password 'TestPassword1',
    use_encrypt true
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'tls_test_secret';
----
1

# Clean up
statement ok
DROP SECRET tls_test_secret;

# ============================================================================
# Test: TLS vs Non-TLS Connection Comparison (if both work)
# Both should return same results for same queries
# ============================================================================
require-env MSSQL_TEST_DSN

statement ok
ATTACH '${MSSQL_TEST_DSN}' AS plain_db (TYPE mssql);

statement ok
ATTACH '${MSSQL_TEST_DSN_TLS}' AS encrypted_db (TYPE mssql);

# Both should return same data
query I
SELECT * FROM mssql_scan('plain_db', 'SELECT 99 AS val');
----
99

query I
SELECT * FROM mssql_scan('encrypted_db', 'SELECT 99 AS val');
----
99

# Cleanup
statement ok
DETACH plain_db;

statement ok
DETACH encrypted_db;
