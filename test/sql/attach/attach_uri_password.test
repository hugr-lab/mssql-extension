# name: test/sql/attach/attach_uri_password.test
# description: Test URI parsing with special characters in passwords
# group: [integration]

require mssql

# This test requires a running SQL Server
require-env MSSQL_TESTDB_URI

#
# Test 1: Standard URI attach works (regression check)
#

statement ok
SET mssql_connection_cache=false;

statement ok
ATTACH '${MSSQL_TESTDB_URI}' AS uri_std (TYPE mssql);

query I
SELECT COUNT(*) >= 0 FROM duckdb_databases() WHERE database_name = 'uri_std';
----
true

statement ok
DETACH uri_std;

#
# Test 2: Password with unencoded @ in URI
# Using a wrong password that contains @ to verify the URI parser correctly
# identifies the host. With the old find('@') bug, the parser would treat
# 'Wrong@localhost' as the host instead of just 'localhost'.
#
# Expected: Authentication failure (not connection/host resolution failure)
#

statement error
ATTACH 'mssql://sa:Wrong@Pass@localhost:1433/master' AS uri_at_pass (TYPE mssql);
----
MSSQL connection validation failed

# Verify no catalog entry exists after failed ATTACH
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'uri_at_pass';
----
0

#
# Test 3: Password with URL-encoded @ (%40) - should also work
#

statement error
ATTACH 'mssql://sa:Wrong%40Pass@localhost:1433/master' AS uri_enc_pass (TYPE mssql);
----
MSSQL connection validation failed
