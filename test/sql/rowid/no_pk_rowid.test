# name: test/sql/rowid/no_pk_rowid.test
# description: Tests for rowid error handling on tables without primary key
# group: [rowid]
#
# REQUIRES: SQL Server running on localhost:1433 with TestDB initialized
# Run with: make integration-test

require mssql

require-env MSSQL_TESTDB_DSN

# Attach the TestDB database
statement ok
ATTACH '${MSSQL_TESTDB_DSN}' AS testdb (TYPE mssql);

# =============================================================================
# Error Tests: Tables without Primary Key
# =============================================================================

# Test 1: rowid on table without PK should fail
statement error
SELECT rowid FROM testdb.dbo.RowidTestNoPK;
----
MSSQL: rowid requires a primary key

# Test 2: rowid with other columns should also fail
statement error
SELECT rowid, message FROM testdb.dbo.RowidTestNoPK;
----
MSSQL: rowid requires a primary key

# =============================================================================
# Success Tests: Non-rowid queries on no-PK tables should work
# =============================================================================

# Test 3: Regular SELECT works fine on no-PK table
query T
SELECT message FROM testdb.dbo.RowidTestNoPK WHERE message IS NOT NULL ORDER BY log_time LIMIT 2;
----
Log entry 1
Log entry 2

# Test 4: COUNT(*) works on no-PK table
query I
SELECT COUNT(*) FROM testdb.dbo.RowidTestNoPK;
----
3

# Test 5: SELECT * works on no-PK table
query TT
SELECT log_time, message FROM testdb.dbo.RowidTestNoPK WHERE message = 'Log entry 1';
----
2024-01-01 10:00:00	Log entry 1

# Cleanup
statement ok
DETACH testdb;
