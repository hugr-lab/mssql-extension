# name: test/sql/multipacket.test
# description: Test multi-packet TDS message support for large SQL statements
# group: [mssql]

require mssql

require-env MSSQL_TEST_DSN

#
# Test 1: Single packet query (baseline - small SQL)
#
statement ok
ATTACH '${MSSQL_TEST_DSN}' AS mp_db (TYPE mssql);

query I
SELECT * FROM mssql_scan('mp_db', 'SELECT 1 AS val');
----
1

#
# Test 2: Multi-packet query (~6KB SQL - requires 2 TDS packets at 4096 packet size)
# The SQL contains a long comment to exceed the packet size
#
query I
SELECT * FROM mssql_scan('mp_db', 'SELECT 42 AS answer /* ' || repeat('x', 3000) || ' */');
----
42

#
# Test 3: Larger multi-packet query (~20KB SQL - requires 5+ TDS packets)
#
query I
SELECT * FROM mssql_scan('mp_db', 'SELECT 123 AS result /* ' || repeat('y', 10000) || ' */');
----
123

#
# Test 4: Very large multi-packet query (~70KB SQL - requires 18+ TDS packets)
#
query I
SELECT * FROM mssql_scan('mp_db', 'SELECT 999 AS big_result /* ' || repeat('z', 35000) || ' */');
----
999

#
# Test 5: Multi-packet with actual data (not just comments)
# Build a long CASE expression
#
query I
SELECT * FROM mssql_scan('mp_db', '
SELECT CASE
    WHEN 1=1 THEN 1
    ' || repeat('WHEN 2=3 THEN 0 ', 500) || '
    ELSE 0
END AS case_result
');
----
1

# Note: Multi-packet INSERT tests require catalog integration.
# SELECT tests above verify multi-packet read operations.

statement ok
DETACH mp_db;
