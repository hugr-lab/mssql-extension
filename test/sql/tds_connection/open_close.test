# name: test/sql/tds_connection/open_close.test
# description: Test mssql_open and mssql_close diagnostic functions
# group: [tds_connection]

require mssql

require-env MSSQL_TEST_DSN

# T015: Test successful connection open with connection string
# Store handle in temp table to avoid hardcoded handle numbers
statement ok
CREATE TEMP TABLE conn_handle AS SELECT mssql_open('${MSSQL_TEST_DSN}') AS handle;

query I
SELECT handle >= 1 FROM conn_handle;
----
true

# Close the connection we just opened
query I
SELECT mssql_close((SELECT handle FROM conn_handle));
----
true

statement ok
DROP TABLE conn_handle;

# T016: Test authentication failure with invalid credentials
# Use connection string with wrong password
statement error
SELECT mssql_open('Server=localhost,1433;Database=master;User Id=sa;Password=WrongPassword123!');
----
Login failed

# T024: Test mssql_close with invalid handle returns true (idempotent)
query I
SELECT mssql_close(99999);
----
true

# T025: Closing the same handle twice is idempotent
query I
SELECT mssql_close(99999);
----
true

# Test with non-existent secret
statement error
SELECT mssql_open('nonexistent_secret');
----
not found
