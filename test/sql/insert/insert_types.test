# name: test/sql/insert/insert_types.test
# description: Test INSERT with various DuckDB types mapped to SQL Server types
# group: [mssql]

# Type mapping:
#   BOOLEAN â†’ BIT (0/1)
#   TINYINT/SMALLINT/INTEGER/BIGINT â†’ corresponding SQL Server types
#   FLOAT/DOUBLE â†’ FLOAT
#   DECIMAL(p,s) â†’ DECIMAL(p,s)
#   VARCHAR â†’ NVARCHAR (Unicode with N'...')
#   BLOB â†’ VARBINARY (0x hex encoding)
#   UUID â†’ UNIQUEIDENTIFIER
#   DATE â†’ DATE
#   TIME â†’ TIME
#   TIMESTAMP â†’ DATETIME2
#   TIMESTAMP WITH TIME ZONE â†’ DATETIMEOFFSET

require mssql

require-env MSSQL_TESTDB_DSN

# Test 1: Attach database
statement ok
ATTACH '${MSSQL_TESTDB_DSN}' AS mssql_ins_types (TYPE mssql);

# Test 2: Create table with all supported types (ensure clean state via mssql_exec)
statement ok
SELECT mssql_exec('mssql_ins_types', '
    IF OBJECT_ID(''dbo.insert_types_test'', ''U'') IS NOT NULL
        DROP TABLE dbo.insert_types_test;
    CREATE TABLE dbo.insert_types_test (
        col_bool BIT,
        col_tinyint TINYINT,
        col_smallint SMALLINT,
        col_int INT,
        col_bigint BIGINT,
        col_float FLOAT,
        col_decimal DECIMAL(10,2),
        col_varchar NVARCHAR(MAX),
        col_blob VARBINARY(MAX),
        col_uuid UNIQUEIDENTIFIER,
        col_date DATE,
        col_time TIME,
        col_timestamp DATETIME2
    )
');

statement ok
SELECT mssql_refresh_cache('mssql_ins_types');

# Test 3: INSERT with basic numeric types
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_bool, col_tinyint, col_smallint, col_int, col_bigint)
VALUES (true, 255, 32767, 2147483647, 9223372036854775807);

query IIIII
SELECT col_bool, col_tinyint, col_smallint, col_int, col_bigint
FROM mssql_ins_types.dbo.insert_types_test WHERE col_tinyint = 255;
----
1	255	32767	2147483647	9223372036854775807

# Test 4: INSERT with BOOLEAN false
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_bool) VALUES (false);

query I
SELECT col_bool FROM mssql_ins_types.dbo.insert_types_test WHERE col_bool = 0;
----
0

# Test 5: INSERT with negative integers
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_smallint, col_int, col_bigint)
VALUES (-32768, -2147483648, -9223372036854775808);

query III
SELECT col_smallint, col_int, col_bigint FROM mssql_ins_types.dbo.insert_types_test WHERE col_smallint = -32768;
----
-32768	-2147483648	-9223372036854775808

# Test 6: INSERT with float and decimal
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_float, col_decimal)
VALUES (3.14159, 12345.67);

query RR
SELECT col_float, col_decimal FROM mssql_ins_types.dbo.insert_types_test WHERE col_decimal = 12345.67;
----
3.14159	12345.67

# Test 7: INSERT with ASCII string
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_varchar) VALUES ('Hello World');

query T
SELECT col_varchar FROM mssql_ins_types.dbo.insert_types_test WHERE col_varchar = N'Hello World';
----
Hello World

# Test 8: INSERT with Unicode Chinese characters
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_varchar) VALUES ('ä½ å¥½ä¸–ç•Œ');

query T
SELECT col_varchar FROM mssql_ins_types.dbo.insert_types_test WHERE col_varchar = N'ä½ å¥½ä¸–ç•Œ';
----
ä½ å¥½ä¸–ç•Œ

# Test 9: INSERT with Unicode emoji
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_varchar) VALUES ('Hello ðŸ˜€ðŸŽ‰ðŸš€');

query I
SELECT COUNT(*) FROM mssql_ins_types.dbo.insert_types_test WHERE col_varchar LIKE N'Hello %';
----
2

# Test 10: INSERT with date and time types
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_date, col_time, col_timestamp)
VALUES ('2026-01-19', '14:30:00', '2026-01-19 14:30:00');

query TT
SELECT CAST(col_date AS VARCHAR), CAST(col_time AS VARCHAR)
FROM mssql_ins_types.dbo.insert_types_test WHERE col_date = '2026-01-19';
----
2026-01-19	14:30:00

# Test 11: INSERT with explicit NULL values
# First verify total row count before this insert (8 rows from tests 3-10)
query I
SELECT COUNT(*) FROM mssql_ins_types.dbo.insert_types_test;
----
8

# Insert with NULLs using a unique marker value (use a large negative SMALLINT)
statement ok
INSERT INTO mssql_ins_types.dbo.insert_types_test (col_bool, col_int, col_varchar, col_smallint)
VALUES (NULL, NULL, NULL, -9999);

# Verify the row was inserted by checking total count
query I
SELECT COUNT(*) FROM mssql_ins_types.dbo.insert_types_test;
----
9

# Verify NULL handling by checking one of the NULL values in the newly inserted row
# We use the COUNT of rows with specific NULL pattern
query I
SELECT COUNT(*) FROM mssql_ins_types.dbo.insert_types_test WHERE col_smallint < 0;
----
2

# Test 12: Cleanup
statement ok
DROP TABLE mssql_ins_types.dbo.insert_types_test;

statement ok
DETACH mssql_ins_types;
