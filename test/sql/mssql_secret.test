# name: test/sql/mssql_secret.test
# description: Test MSSQL secret creation and validation
# group: [mssql]

require mssql

# T010: Test secret creation with valid parameters
statement ok
CREATE SECRET test_secret (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'test_secret';
----
1

# Clean up
statement ok
DROP SECRET test_secret;

# T011: Test missing required field - host
statement error
CREATE SECRET missing_host (
    TYPE mssql,
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);
----
Missing required field 'host'

# T011: Test missing required field - port
statement error
CREATE SECRET missing_port (
    TYPE mssql,
    host 'test-host',
    database 'testdb',
    user 'testuser',
    password 'testpass'
);
----
Missing required field 'port'

# T011: Test missing required field - database
statement error
CREATE SECRET missing_database (
    TYPE mssql,
    host 'test-host',
    port 1433,
    user 'testuser',
    password 'testpass'
);
----
Missing required field 'database'

# T011: Test missing required field - user
statement error
CREATE SECRET missing_user (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    password 'testpass'
);
----
Missing required field 'user'

# T011: Test missing required field - password
statement error
CREATE SECRET missing_password (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser'
);
----
Missing required field 'password'

# T012: Test invalid port number - 0
statement error
CREATE SECRET invalid_port_zero (
    TYPE mssql,
    host 'test-host',
    port 0,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);
----
Port must be between 1 and 65535

# T012: Test invalid port number - negative
statement error
CREATE SECRET invalid_port_negative (
    TYPE mssql,
    host 'test-host',
    port -1,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);
----
Port must be between 1 and 65535

# T012: Test invalid port number - too large
statement error
CREATE SECRET invalid_port_large (
    TYPE mssql,
    host 'test-host',
    port 65536,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);
----
Port must be between 1 and 65535

# T013: Test password redaction in duckdb_secrets() output
statement ok
CREATE SECRET redacted_test (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'supersecret'
);

# Verify password is redacted (should not contain 'supersecret')
query I
SELECT secret_string NOT LIKE '%supersecret%' FROM duckdb_secrets() WHERE name = 'redacted_test';
----
true

# Clean up
statement ok
DROP SECRET redacted_test;

# Test valid port boundaries
statement ok
CREATE SECRET port_min (
    TYPE mssql,
    host 'test-host',
    port 1,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);

statement ok
DROP SECRET port_min;

statement ok
CREATE SECRET port_max (
    TYPE mssql,
    host 'test-host',
    port 65535,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);

statement ok
DROP SECRET port_max;

# Test use_encrypt parameter (optional)
statement ok
CREATE SECRET encrypt_enabled (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass',
    use_encrypt true
);

# Verify secret exists with encryption enabled
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'encrypt_enabled';
----
1

statement ok
DROP SECRET encrypt_enabled;

# Test use_encrypt set to false explicitly
statement ok
CREATE SECRET encrypt_disabled (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass',
    use_encrypt false
);

statement ok
DROP SECRET encrypt_disabled;

# Test without use_encrypt (should default to false)
statement ok
CREATE SECRET encrypt_default (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);

statement ok
DROP SECRET encrypt_default;
