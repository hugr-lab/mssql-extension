# name: test/sql/tls_secret.test
# description: Test MSSQL secret creation with TLS/encryption options
# group: [mssql]

require mssql

# ============================================================================
# Test: Secret with use_encrypt=true
# ============================================================================
statement ok
CREATE SECRET tls_enabled_secret (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass',
    use_encrypt true
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'tls_enabled_secret';
----
1

statement ok
DROP SECRET tls_enabled_secret;

# ============================================================================
# Test: Secret with use_encrypt=false
# ============================================================================
statement ok
CREATE SECRET tls_disabled_secret (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass',
    use_encrypt false
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'tls_disabled_secret';
----
1

statement ok
DROP SECRET tls_disabled_secret;

# ============================================================================
# Test: Secret without use_encrypt (should default to false)
# ============================================================================
statement ok
CREATE SECRET tls_default_secret (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'testpass'
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'tls_default_secret';
----
1

statement ok
DROP SECRET tls_default_secret;

# ============================================================================
# Test: All parameters including TLS
# ============================================================================
statement ok
CREATE SECRET full_params_secret (
    TYPE mssql,
    host 'myserver.database.windows.net',
    port 1433,
    database 'production',
    user 'admin@myserver',
    password 'SecurePass123!',
    use_encrypt true
);

query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'full_params_secret';
----
1

statement ok
DROP SECRET full_params_secret;

# ============================================================================
# Test: Azure SQL Database style connection (always requires TLS)
# ============================================================================
statement ok
CREATE SECRET azure_sql_secret (
    TYPE mssql,
    host 'myserver.database.windows.net',
    port 1433,
    database 'mydb',
    user 'myuser@myserver',
    password 'MyPassword!',
    use_encrypt true
);

query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE type = 'mssql' AND name = 'azure_sql_secret';
----
1

statement ok
DROP SECRET azure_sql_secret;

# ============================================================================
# Test: Password not revealed in secret output
# ============================================================================
statement ok
CREATE SECRET password_redaction_test (
    TYPE mssql,
    host 'test-host',
    port 1433,
    database 'testdb',
    user 'testuser',
    password 'SuperSecretPassword123',
    use_encrypt true
);

# Password should be redacted
query I
SELECT secret_string NOT LIKE '%SuperSecretPassword123%' FROM duckdb_secrets() WHERE name = 'password_redaction_test';
----
true

statement ok
DROP SECRET password_redaction_test;
