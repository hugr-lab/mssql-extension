# name: test/sql/azure/azure_secret_validation.test
# description: Test MSSQL secret creation with azure_secret parameter
# group: [azure]

require mssql

# Test: MSSQL secret without user/password and without azure_secret fails
statement error
CREATE SECRET test_mssql_no_auth (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb'
);
----
Either user/password or azure_secret required

# Test: MSSQL secret with only user (no password) and no azure_secret fails
statement error
CREATE SECRET test_mssql_user_only (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    USER 'testuser'
);
----
Missing required field 'password'

# Test: Traditional SQL auth still works (backward compatibility)
statement ok
CREATE SECRET test_mssql_sql_auth (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    USER 'testuser',
    PASSWORD 'testpass'
);

# Verify secret was created
query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'test_mssql_sql_auth';
----
1

# Clean up
statement ok
DROP SECRET IF EXISTS test_mssql_sql_auth;

# Test: MSSQL secret with non-existent azure_secret fails
statement error
CREATE SECRET test_mssql_missing_azure (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    AZURE_SECRET 'nonexistent_azure'
);
----
Azure secret 'nonexistent_azure' not found

# Test with actual Azure credentials
require-env AZURE_APP_ID

require-env AZURE_DIRECTORY_ID

require-env AZURE_APP_SECRET

require azure

# Create Azure secret first
statement ok
CREATE OR REPLACE SECRET valid_azure_secret (
    TYPE azure,
    PROVIDER service_principal,
    TENANT_ID '${AZURE_DIRECTORY_ID}',
    CLIENT_ID '${AZURE_APP_ID}',
    CLIENT_SECRET '${AZURE_APP_SECRET}'
);

# Test: MSSQL secret with valid azure_secret succeeds (no user/password required)
statement ok
CREATE SECRET test_mssql_azure_auth (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    AZURE_SECRET 'valid_azure_secret'
);

# Verify secret was created
query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'test_mssql_azure_auth';
----
1

# Test: MSSQL secret with both azure_secret and user/password (both are stored)
statement ok
CREATE SECRET test_mssql_both_auth (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    USER 'ignored_user',
    PASSWORD 'ignored_pass',
    AZURE_SECRET 'valid_azure_secret'
);

# Verify secret was created
query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'test_mssql_both_auth';
----
1

# Clean up
statement ok
DROP SECRET IF EXISTS test_mssql_azure_auth;

statement ok
DROP SECRET IF EXISTS test_mssql_both_auth;

statement ok
DROP SECRET IF EXISTS valid_azure_secret;
