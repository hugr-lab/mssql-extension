# name: test/sql/azure/azure_secret_token_only.test
# description: Test access_token provider for Azure secrets (Issue #57)
# group: [azure]

require mssql

require azure

# =============================================================================
# Test 1: Create Azure secret with access_token provider
# =============================================================================

statement ok
CREATE SECRET azure_token_test (
    TYPE azure,
    PROVIDER access_token,
    ACCESS_TOKEN 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJodHRwczovL2RhdGFiYXNlLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LyIsImV4cCI6OTk5OTk5OTk5OX0.fake-signature'
);

# Verify secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'azure_token_test';
----
1

# Verify token is redacted
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'azure_token_test' AND secret_string NOT LIKE '%eyJ0eXAi%';
----
1

# =============================================================================
# Test 2: Create MSSQL secret referencing Azure access_token secret
# =============================================================================

statement ok
CREATE SECRET mssql_with_azure_token (
    TYPE mssql,
    HOST 'myserver.database.windows.net',
    PORT 1433,
    DATABASE 'mydb',
    AZURE_SECRET 'azure_token_test'
);

# Verify MSSQL secret exists
query I
SELECT COUNT(*) FROM duckdb_secrets() WHERE name = 'mssql_with_azure_token';
----
1

# =============================================================================
# Cleanup
# =============================================================================

statement ok
DROP SECRET IF EXISTS mssql_with_azure_token;

statement ok
DROP SECRET IF EXISTS azure_token_test;
