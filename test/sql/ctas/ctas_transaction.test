# name: test/sql/ctas/ctas_transaction.test
# description: Test CTAS behavior within transactions
# group: [mssql]

# Environment variables required:
#   MSSQL_TESTDB_DSN - Connection string to test database

require mssql

require-env MSSQL_TESTDB_DSN

# Test 1: Attach database
statement ok
ATTACH '${MSSQL_TESTDB_DSN}' AS mssql_tx (TYPE mssql);

# Cleanup any leftover test tables
statement ok
DROP TABLE IF EXISTS mssql_tx.dbo.ctas_tx_test;

statement ok
DROP TABLE IF EXISTS mssql_tx.dbo.ctas_tx_commit;

statement ok
DROP TABLE IF EXISTS mssql_tx.dbo.ctas_tx_rollback;

# =============================================================================
# CTAS in Transaction - COMMIT
# =============================================================================

# Note: DDL (CREATE TABLE) auto-commits in SQL Server, but INSERT data
# respects the transaction. After rollback, table exists but is empty.

statement ok
BEGIN;

statement ok
CREATE TABLE mssql_tx.dbo.ctas_tx_commit AS
SELECT 1 AS id, 'committed' AS name;

statement ok
COMMIT;

# Verify data persisted after commit
query IT
SELECT * FROM mssql_tx.dbo.ctas_tx_commit;
----
1	committed

# =============================================================================
# CTAS in Transaction - Verify data in autocommit mode
# =============================================================================

# Test: CTAS outside of explicit transaction auto-commits
statement ok
CREATE TABLE mssql_tx.dbo.ctas_tx_test AS
SELECT i AS id, 'auto_' || i::VARCHAR AS name
FROM generate_series(1, 3) t(i);

query I
SELECT COUNT(*) FROM mssql_tx.dbo.ctas_tx_test;
----
3

# =============================================================================
# Cleanup
# =============================================================================

statement ok
DROP TABLE mssql_tx.dbo.ctas_tx_test;

statement ok
DROP TABLE mssql_tx.dbo.ctas_tx_commit;

statement ok
DETACH mssql_tx;
