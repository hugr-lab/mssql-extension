# name: test/sql/ctas/ctas_basic.test
# description: Test basic CREATE TABLE AS SELECT operations via catalog
# group: [mssql]

# Environment variables required:
#   MSSQL_TESTDB_DSN - Connection string to test database
#   Example: Server=localhost,1433;Database=testdb;User Id=sa;Password=YourPassword123

require mssql

require-env MSSQL_TESTDB_DSN

# Test 1: Attach database with READ_WRITE mode (required for CTAS)
statement ok
ATTACH '${MSSQL_TESTDB_DSN}' AS mssql_ctas_basic (TYPE mssql);

# Test 2: Cleanup any leftover test tables
statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_simple;

statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_multirow;

statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_types;

statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_empty;

statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_exists_test;

# Test 3: Simple CTAS with scalar values
statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_simple AS SELECT 1 AS id, 'hello' AS name;

# Test 4: Verify simple CTAS result
query IT
SELECT * FROM mssql_ctas_basic.dbo.ctas_simple;
----
1	hello

# Test 5: CTAS with multiple rows from generate_series
statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_multirow AS
SELECT i AS id, 'row_' || i::VARCHAR AS name
FROM generate_series(1, 10) t(i);

# Test 6: Verify multi-row CTAS
query I
SELECT COUNT(*) FROM mssql_ctas_basic.dbo.ctas_multirow;
----
10

query IT
SELECT * FROM mssql_ctas_basic.dbo.ctas_multirow WHERE id = 5;
----
5	row_5

# Test 7: CTAS with various supported types
statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_types AS
SELECT
    1::INTEGER AS col_int,
    123456789012::BIGINT AS col_bigint,
    42::SMALLINT AS col_smallint,
    127::TINYINT AS col_tinyint,
    true AS col_bool,
    3.14::FLOAT AS col_float,
    2.718281828::DOUBLE AS col_double,
    123.45::DECIMAL(10, 2) AS col_decimal,
    'test string' AS col_varchar,
    DATE '2024-01-15' AS col_date,
    TIME '10:30:45' AS col_time,
    TIMESTAMP '2024-01-15 10:30:45' AS col_timestamp;

# Test 8: Verify types table data
query IIIIIRRRTTTT
SELECT * FROM mssql_ctas_basic.dbo.ctas_types;
----
1	123456789012	42	127	1	3.14	2.718281828	123.45	test string	2024-01-15	10:30:45	2024-01-15 10:30:45

# Test 9: Zero-row CTAS (empty result set)
statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_empty AS
SELECT 1 AS id, 'never' AS name
WHERE false;

# Test 10: Verify zero-row table exists and is empty
query I
SELECT COUNT(*) FROM mssql_ctas_basic.dbo.ctas_empty;
----
0

# Test 11: Table already exists error (no OR REPLACE)
statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_exists_test AS SELECT 1 AS id;

statement error
CREATE TABLE mssql_ctas_basic.dbo.ctas_exists_test AS SELECT 2 AS id;
----
already

# Test 12: Non-existent schema error
statement error
CREATE TABLE mssql_ctas_basic.nonexistent_schema_12345.ctas_fail AS SELECT 1 AS id;
----
not found

# Test 13: CTAS from local DuckDB table
statement ok
CREATE TABLE local_source AS
SELECT i AS id, 'local_' || i::VARCHAR AS name
FROM generate_series(1, 5) t(i);

statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_from_local;

statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_from_local AS
SELECT * FROM local_source;

query I
SELECT COUNT(*) FROM mssql_ctas_basic.dbo.ctas_from_local;
----
5

# Test 14: CTAS with NULL values
statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_nulls;

statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_nulls AS
SELECT 1 AS id, NULL::VARCHAR AS name, NULL::INTEGER AS value;

query ITI
SELECT * FROM mssql_ctas_basic.dbo.ctas_nulls;
----
1	NULL	NULL

# Test 15: CTAS with expressions and aliases
statement ok
DROP TABLE IF EXISTS mssql_ctas_basic.dbo.ctas_expr;

statement ok
CREATE TABLE mssql_ctas_basic.dbo.ctas_expr AS
SELECT
    i AS id,
    i * 2 AS doubled,
    i * i AS squared,
    CASE WHEN i % 2 = 0 THEN 'even' ELSE 'odd' END AS parity
FROM generate_series(1, 5) t(i);

query I
SELECT COUNT(*) FROM mssql_ctas_basic.dbo.ctas_expr WHERE parity = 'even';
----
2

# Cleanup
statement ok
DROP TABLE local_source;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_simple;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_multirow;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_types;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_empty;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_exists_test;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_from_local;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_nulls;

statement ok
DROP TABLE mssql_ctas_basic.dbo.ctas_expr;

statement ok
DETACH mssql_ctas_basic;
