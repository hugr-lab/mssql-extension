# name: test/sql/mssql_attach.test
# description: Test MSSQL database attach and detach with different connection formats
# group: [mssql]

require mssql

require-env MSSQL_TEST_DSN

require-env MSSQL_TEST_URI

require-env MSSQL_TEST_HOST

require-env MSSQL_TEST_PORT

require-env MSSQL_TEST_USER

require-env MSSQL_TEST_PASS

require-env MSSQL_TEST_DB

#
# Test 1: ATTACH with ADO.NET connection string (key-value format)
#
statement ok
ATTACH '${MSSQL_TEST_DSN}' AS kv_db (TYPE mssql);

query I
SELECT * FROM mssql_scan('kv_db', 'SELECT 1 AS val');
----
1

statement ok
DETACH kv_db;

#
# Test 2: ATTACH with URI format connection string
#
statement ok
ATTACH '${MSSQL_TEST_URI}' AS uri_db (TYPE mssql);

query I
SELECT * FROM mssql_scan('uri_db', 'SELECT 2 AS val');
----
2

statement ok
DETACH uri_db;

#
# Test 3: ATTACH with SECRET
#
statement ok
CREATE SECRET attach_test_secret (
    TYPE mssql,
    host '${MSSQL_TEST_HOST}',
    port ${MSSQL_TEST_PORT},
    database '${MSSQL_TEST_DB}',
    user '${MSSQL_TEST_USER}',
    password '${MSSQL_TEST_PASS}'
);

statement ok
ATTACH '' AS secret_db (TYPE mssql, SECRET attach_test_secret);

query I
SELECT * FROM mssql_scan('secret_db', 'SELECT 3 AS val');
----
3

statement ok
DETACH secret_db;

statement ok
DROP SECRET attach_test_secret;

#
# Test 4: Re-attach after detach
#
statement ok
ATTACH '${MSSQL_TEST_DSN}' AS reattach_db (TYPE mssql);

statement ok
DETACH reattach_db;

statement ok
ATTACH '${MSSQL_TEST_DSN}' AS reattach_db (TYPE mssql);

statement ok
DETACH reattach_db;

#
# Error handling tests
#

# T020: Test attach without secret or connection string (should fail)
statement error
ATTACH '' AS no_secret_db (TYPE mssql);
----
Either SECRET or connection string is required

# T021: Test attach with non-existent secret (should fail)
statement error
ATTACH '' AS bad_secret_db (TYPE mssql, SECRET nonexistent_secret);
----
not found

# T025: Test detach non-existent context (should fail)
statement error
DETACH nonexistent_db;
----
not found

#
# Connection string validation tests
#

# Missing Server
statement error
ATTACH 'Database=testdb;User Id=testuser;Password=testpass' AS invalid_conn_str (TYPE mssql);
----
Missing 'Server' in connection string

# Missing Database
statement error
ATTACH 'Server=test-host;User Id=testuser;Password=testpass' AS invalid_conn_str2 (TYPE mssql);
----
Missing 'Database' in connection string

# Missing User Id
statement error
ATTACH 'Server=test-host;Database=testdb;Password=testpass' AS invalid_conn_str3 (TYPE mssql);
----
Missing 'User Id' in connection string

# Missing Password
statement error
ATTACH 'Server=test-host;Database=testdb;User Id=testuser' AS invalid_conn_str4 (TYPE mssql);
----
Missing 'Password' in connection string

# Invalid port
statement error
ATTACH 'Server=test-host,99999;Database=testdb;User Id=testuser;Password=testpass' AS invalid_port_conn (TYPE mssql);
----
Port must be between 1 and 65535
