# name: test/sql/copy/copy_temp.test
# description: Test COPY TO MSSQL temp tables (#temp and ##global_temp)
# group: [copy]

require mssql

# Skip if no MSSQL server available
require-env MSSQL_TEST_DATABASE

statement ok
SET mssql_debug_level=1;

# Attach to SQL Server
statement ok
ATTACH '${MSSQL_TEST_DATABASE}' AS sqlsrv (TYPE mssql);

# Create a local table with test data
statement ok
CREATE TABLE local_data AS SELECT
    i AS id,
    'Name ' || i AS name,
    i * 1.5 AS value
FROM range(1, 51) t(i);

# ===========================================================================
# Test 1: COPY to session-scoped temp table within a transaction
# ===========================================================================

# Start a transaction to pin the connection
statement ok
BEGIN TRANSACTION;

# First, create the temp table on SQL Server (must be done in same transaction)
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE #staging (id int, name nvarchar(100), value float)');

# COPY data to the temp table
statement ok
COPY local_data TO 'mssql://sqlsrv/#staging' (FORMAT 'bcp');

# Verify data was copied - temp table should be accessible on same connection
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #staging');
----
50

# Verify specific values
query II
SELECT id, name FROM mssql_scan('sqlsrv', 'SELECT id, name FROM #staging WHERE id = 25');
----
25	Name 25

# We can also run subsequent operations on the temp table
statement ok
CALL mssql_exec('sqlsrv', 'INSERT INTO #staging VALUES (999, ''Extra Row'', 0.0)');

query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #staging');
----
51

# Commit the transaction
statement ok
COMMIT;

# ===========================================================================
# Test 2: COPY to temp table with CREATE_TABLE option
# ===========================================================================

statement ok
BEGIN TRANSACTION;

# COPY with CREATE_TABLE should create the temp table automatically
statement ok
COPY local_data TO 'mssql://sqlsrv/#auto_created_temp' (FORMAT 'bcp', CREATE_TABLE true);

# Verify temp table was created and data was copied
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #auto_created_temp');
----
50

statement ok
COMMIT;

# ===========================================================================
# Test 3: COPY to global temp table (##)
# ===========================================================================

statement ok
BEGIN TRANSACTION;

# Create global temp table
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS ##global_staging');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE ##global_staging (id int, name nvarchar(100), value float)');

# COPY to global temp table
statement ok
COPY local_data TO 'mssql://sqlsrv/##global_staging' (FORMAT 'bcp');

# Verify
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM ##global_staging');
----
50

# Cleanup global temp (it persists across connections)
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS ##global_staging');

statement ok
COMMIT;

# ===========================================================================
# Test 4: Multiple COPY operations to same temp table (append mode)
# ===========================================================================

statement ok
BEGIN TRANSACTION;

# Create temp table
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE #append_test (id int, name nvarchar(100), value float)');

# First COPY
statement ok
COPY local_data TO 'mssql://sqlsrv/#append_test' (FORMAT 'bcp');

# Second COPY (should append)
statement ok
COPY local_data TO 'mssql://sqlsrv/#append_test' (FORMAT 'bcp');

# Should have 100 rows total (50 + 50)
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #append_test');
----
100

statement ok
COMMIT;

# ===========================================================================
# Test 5: Default schema handling for temp tables (should ignore schema)
# ===========================================================================

statement ok
BEGIN TRANSACTION;

# Create temp table
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE #schema_test (id int, name nvarchar(100), value float)');

# COPY using explicit dbo schema (should still work - temp tables don't really use schemas)
statement ok
COPY local_data TO 'mssql://sqlsrv/dbo/#schema_test' (FORMAT 'bcp');

query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #schema_test');
----
50

statement ok
COMMIT;

# Clean up local table
statement ok
DROP TABLE local_data;

# Detach
statement ok
DETACH sqlsrv;
