# name: test/sql/copy/copy_large.test
# description: Test COPY TO MSSQL with large datasets to verify bounded memory and batch streaming
# group: [copy]

require mssql

# Skip if no MSSQL server available
require-env MSSQL_TEST_DATABASE

statement ok
SET mssql_debug_level=1;

# Attach to SQL Server
statement ok
ATTACH '${MSSQL_TEST_DATABASE}' AS sqlsrv (TYPE mssql);

# ===========================================================================
# Test 1: Large dataset - 100K rows
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_large_100k');

# Create local table with 100K rows
statement ok
CREATE TABLE large_100k AS SELECT
    i AS id,
    'Name ' || i AS name,
    i * 1.5 AS value,
    CASE WHEN i % 2 = 0 THEN true ELSE false END AS active
FROM range(1, 100001) t(i);

# COPY to SQL Server with CREATE_TABLE
statement ok
COPY large_100k TO 'mssql://sqlsrv/dbo/copy_large_100k' (FORMAT 'bcp', CREATE_TABLE true);

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_large_100k');
----
100000

# Verify first and last rows
query III
SELECT id, name, active FROM mssql_scan('sqlsrv', 'SELECT id, name, active FROM dbo.copy_large_100k WHERE id = 1');
----
1	Name 1	0

query III
SELECT id, name, active FROM mssql_scan('sqlsrv', 'SELECT id, name, active FROM dbo.copy_large_100k WHERE id = 100000');
----
100000	Name 100000	1

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_large_100k');

statement ok
DROP TABLE large_100k;

# ===========================================================================
# Test 2: Large dataset with many columns - 50K rows x 10 columns
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_wide_table');

statement ok
CREATE TABLE wide_table AS SELECT
    i AS col1,
    i + 1 AS col2,
    i + 2 AS col3,
    i + 3 AS col4,
    i + 4 AS col5,
    'String value ' || i AS col6,
    'Another string ' || i AS col7,
    i * 1.5 AS col8,
    i * 2.5 AS col9,
    CASE WHEN i % 3 = 0 THEN true ELSE false END AS col10
FROM range(1, 50001) t(i);

statement ok
COPY wide_table TO 'mssql://sqlsrv/dbo/copy_wide_table' (FORMAT 'bcp', CREATE_TABLE true);

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_wide_table');
----
50000

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_wide_table');

statement ok
DROP TABLE wide_table;

# ===========================================================================
# Test 3: Large text data - 10K rows with long strings
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_long_strings');

statement ok
CREATE TABLE long_strings AS SELECT
    i AS id,
    repeat('A', 500) || i::VARCHAR AS long_text
FROM range(1, 10001) t(i);

statement ok
COPY long_strings TO 'mssql://sqlsrv/dbo/copy_long_strings' (FORMAT 'bcp', CREATE_TABLE true);

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_long_strings');
----
10000

# Verify string length
query I
SELECT LEN(long_text) FROM mssql_scan('sqlsrv', 'SELECT LEN(long_text) AS len FROM dbo.copy_long_strings WHERE id = 1');
----
501

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_long_strings');

statement ok
DROP TABLE long_strings;

# ===========================================================================
# Test 4: Custom batch size - smaller batches
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_small_batch');

statement ok
CREATE TABLE small_batch AS SELECT
    i AS id,
    'Value ' || i AS name
FROM range(1, 10001) t(i);

# COPY with small batch size
statement ok
COPY small_batch TO 'mssql://sqlsrv/dbo/copy_small_batch' (FORMAT 'bcp', CREATE_TABLE true, BATCH_ROWS 100);

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_small_batch');
----
10000

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_small_batch');

statement ok
DROP TABLE small_batch;

# ===========================================================================
# Test 5: Append multiple batches to same table
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_append_large');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_append_large (id int, batch int)');

# First batch - 10K rows
statement ok
CREATE TABLE batch1 AS SELECT i AS id, 1 AS batch FROM range(1, 10001) t(i);

statement ok
COPY batch1 TO 'mssql://sqlsrv/dbo/copy_append_large' (FORMAT 'bcp');

statement ok
DROP TABLE batch1;

# Second batch - 10K rows
statement ok
CREATE TABLE batch2 AS SELECT i AS id, 2 AS batch FROM range(10001, 20001) t(i);

statement ok
COPY batch2 TO 'mssql://sqlsrv/dbo/copy_append_large' (FORMAT 'bcp');

statement ok
DROP TABLE batch2;

# Third batch - 10K rows
statement ok
CREATE TABLE batch3 AS SELECT i AS id, 3 AS batch FROM range(20001, 30001) t(i);

statement ok
COPY batch3 TO 'mssql://sqlsrv/dbo/copy_append_large' (FORMAT 'bcp');

statement ok
DROP TABLE batch3;

# Verify total row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_append_large');
----
30000

# Verify batch distribution
query II
SELECT batch, COUNT(*) AS cnt FROM mssql_scan('sqlsrv', 'SELECT batch, COUNT(*) AS cnt FROM dbo.copy_append_large GROUP BY batch ORDER BY batch');
----
1	10000
2	10000
3	10000

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_append_large');

# Detach
statement ok
DETACH sqlsrv;
