# name: test/sql/copy/copy_basic.test
# description: Test basic COPY TO MSSQL via BCP protocol
# group: [copy]

require mssql

# Skip if no MSSQL server available
require-env MSSQL_TEST_DATABASE

statement ok
SET mssql_debug_level=1;

# Attach to SQL Server
statement ok
ATTACH '${MSSQL_TEST_DATABASE}' AS sqlsrv (TYPE mssql);

# Create a local table with test data
statement ok
CREATE TABLE local_data AS SELECT
    i AS id,
    'Name ' || i AS name,
    i * 1.5 AS value,
    CASE WHEN i % 2 = 0 THEN true ELSE false END AS active,
    DATE '2024-01-01' + INTERVAL (i) DAY AS created_date
FROM range(1, 101) t(i);

# Test 1: Basic COPY to existing table
# First, create the target table on SQL Server
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_basic_test');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_basic_test (id int, name nvarchar(100), value float, active bit, created_date date)');

# COPY data to SQL Server
statement ok
COPY local_data TO 'mssql://sqlsrv/dbo/copy_basic_test' (FORMAT 'bcp');

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_basic_test');
----
100

# Verify data integrity by checking some specific values
query III
SELECT id, name, active FROM mssql_scan('sqlsrv', 'SELECT id, name, active FROM dbo.copy_basic_test WHERE id = 1');
----
1	Name 1	0

query III
SELECT id, name, active FROM mssql_scan('sqlsrv', 'SELECT id, name, active FROM dbo.copy_basic_test WHERE id = 50');
----
50	Name 50	1

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_basic_test');

# Test 2: COPY with CREATE_TABLE option
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_auto_create');

statement ok
COPY local_data TO 'mssql://sqlsrv/dbo/copy_auto_create' (FORMAT 'bcp', CREATE_TABLE true);

# Verify table was created and data was copied
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_auto_create');
----
100

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_auto_create');

# Test 3: COPY with OVERWRITE option
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_overwrite_test (old_col int)');

statement ok
CALL mssql_exec('sqlsrv', 'INSERT INTO dbo.copy_overwrite_test VALUES (999)');

# Verify old data exists
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_overwrite_test');
----
1

# COPY with overwrite
statement ok
COPY local_data TO 'mssql://sqlsrv/dbo/copy_overwrite_test' (FORMAT 'bcp', OVERWRITE true);

# Verify new data (table recreated with new schema)
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_overwrite_test');
----
100

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_overwrite_test');

# Test 4: Error case - COPY to non-existent table without CREATE_TABLE
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.nonexistent_table');

statement error
COPY local_data TO 'mssql://sqlsrv/dbo/nonexistent_table' (FORMAT 'bcp');
----
does not exist

# Test 5: Error case - COPY to a view
statement ok
CALL mssql_exec('sqlsrv', 'DROP VIEW IF EXISTS dbo.copy_test_view');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_test_base (id int)');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE VIEW dbo.copy_test_view AS SELECT * FROM dbo.copy_test_base');

statement error
COPY local_data TO 'mssql://sqlsrv/dbo/copy_test_view' (FORMAT 'bcp', CREATE_TABLE true);
----
view

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP VIEW IF EXISTS dbo.copy_test_view');

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_test_base');

# Clean up local table
statement ok
DROP TABLE local_data;

# Detach
statement ok
DETACH sqlsrv;
