# name: test/sql/copy/copy_create_overwrite.test
# description: Test COPY TO MSSQL CREATE_TABLE and OVERWRITE options with schema validation
# group: [copy]

require mssql

# Skip if no MSSQL server available
require-env MSSQL_TEST_DATABASE

statement ok
SET mssql_debug_level=1;

# Attach to SQL Server
statement ok
ATTACH '${MSSQL_TEST_DATABASE}' AS sqlsrv (TYPE mssql);

# ===========================================================================
# Test 1: CREATE_TABLE creates table with correct schema
# ===========================================================================

# Create local source table with various types
statement ok
CREATE TABLE source_types AS SELECT
    1 AS int_col,
    'hello' AS varchar_col,
    1.5 AS double_col,
    true AS bool_col,
    DATE '2024-01-15' AS date_col;

# Ensure target doesn't exist
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.auto_schema_test');

# COPY with CREATE_TABLE
statement ok
COPY source_types TO 'mssql://sqlsrv/dbo/auto_schema_test' (FORMAT 'bcp', CREATE_TABLE true);

# Verify data
query IIRBI
SELECT int_col, varchar_col, double_col, bool_col, date_col FROM sqlsrv.dbo.auto_schema_test;
----
1	hello	1.5	true	2024-01-15

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.auto_schema_test');

statement ok
DROP TABLE source_types;

# ===========================================================================
# Test 2: OVERWRITE drops and recreates table
# ===========================================================================

# Create a table with different schema
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.overwrite_test (old_col1 int, old_col2 varchar(50))');

statement ok
CALL mssql_exec('sqlsrv', 'INSERT INTO dbo.overwrite_test VALUES (999, ''old data'')');

# Verify old data exists
query II
SELECT old_col1, old_col2 FROM sqlsrv.dbo.overwrite_test;
----
999	old data

# Create new source with different schema
statement ok
CREATE TABLE new_source AS SELECT
    i AS id,
    'Name ' || i AS name,
    i * 1.5 AS value
FROM range(1, 6) t(i);

# COPY with OVERWRITE - should drop and recreate
statement ok
COPY new_source TO 'mssql://sqlsrv/dbo/overwrite_test' (FORMAT 'bcp', OVERWRITE true);

# Verify new schema and data
query IIR
SELECT id, name, value FROM sqlsrv.dbo.overwrite_test ORDER BY id;
----
1	Name 1	1.5
2	Name 2	3.0
3	Name 3	4.5
4	Name 4	6.0
5	Name 5	7.5

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.overwrite_test');

statement ok
DROP TABLE new_source;

# ===========================================================================
# Test 3: Schema validation - column count mismatch
# ===========================================================================

# Create target table with 2 columns
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.schema_mismatch (col1 int, col2 varchar(100))');

# Create source with 3 columns
statement ok
CREATE TABLE source_3col AS SELECT 1 AS a, 2 AS b, 3 AS c;

# COPY should fail - column count mismatch
statement error
COPY source_3col TO 'mssql://sqlsrv/dbo/schema_mismatch' (FORMAT 'bcp');
----
Column count mismatch

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.schema_mismatch');

statement ok
DROP TABLE source_3col;

# ===========================================================================
# Test 4: Schema validation - column name mismatch
# ===========================================================================

# Create target table
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.name_mismatch (id int, wrong_name varchar(100))');

# Create source with different column names
statement ok
CREATE TABLE source_names AS SELECT 1 AS id, 'test' AS correct_name;

# COPY should fail - column name mismatch
statement error
COPY source_names TO 'mssql://sqlsrv/dbo/name_mismatch' (FORMAT 'bcp');
----
Column name mismatch

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.name_mismatch');

statement ok
DROP TABLE source_names;

# ===========================================================================
# Test 5: Schema validation - type compatibility
# ===========================================================================

# Create target table with compatible types (int can accept tinyint)
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.type_compat (id int, name nvarchar(100))');

# Create source - should be compatible
statement ok
CREATE TABLE source_compat AS SELECT 1::TINYINT AS id, 'test' AS name;

# COPY should succeed - types are compatible
statement ok
COPY source_compat TO 'mssql://sqlsrv/dbo/type_compat' (FORMAT 'bcp');

# Verify
query II
SELECT id, name FROM sqlsrv.dbo.type_compat;
----
1	test

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.type_compat');

statement ok
DROP TABLE source_compat;

# ===========================================================================
# Test 6: Schema validation - type incompatibility
# ===========================================================================

# Create target table with incompatible type
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.type_incompat (id uniqueidentifier)');

# Create source with incompatible type (int cannot go to uniqueidentifier)
statement ok
CREATE TABLE source_incompat AS SELECT 123 AS id;

# COPY should fail - type incompatibility
statement error
COPY source_incompat TO 'mssql://sqlsrv/dbo/type_incompat' (FORMAT 'bcp');
----
Type mismatch

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.type_incompat');

statement ok
DROP TABLE source_incompat;

# ===========================================================================
# Test 7: Append to existing compatible table
# ===========================================================================

# Create target table
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.append_test (id int, name nvarchar(100))');

statement ok
CALL mssql_exec('sqlsrv', 'INSERT INTO dbo.append_test VALUES (1, ''existing'')');

# Create source
statement ok
CREATE TABLE source_append AS SELECT 2 AS id, 'new' AS name;

# COPY without CREATE_TABLE or OVERWRITE - should append
statement ok
COPY source_append TO 'mssql://sqlsrv/dbo/append_test' (FORMAT 'bcp');

# Verify both rows exist
query II
SELECT id, name FROM sqlsrv.dbo.append_test ORDER BY id;
----
1	existing
2	new

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.append_test');

statement ok
DROP TABLE source_append;

# ===========================================================================
# Test 8: CREATE_TABLE with all supported types
# ===========================================================================

statement ok
CREATE TABLE all_types AS SELECT
    1::TINYINT AS tinyint_col,
    2::SMALLINT AS smallint_col,
    3::INTEGER AS int_col,
    4::BIGINT AS bigint_col,
    1.5::FLOAT AS float_col,
    2.5::DOUBLE AS double_col,
    123.45::DECIMAL(10,2) AS decimal_col,
    'hello'::VARCHAR AS varchar_col,
    '\xDEADBEEF'::BLOB AS blob_col,
    'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'::UUID AS uuid_col,
    DATE '2024-01-15' AS date_col,
    TIME '14:30:00' AS time_col,
    TIMESTAMP '2024-01-15 14:30:00' AS timestamp_col,
    true AS bool_col;

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.all_types_test');

# COPY with CREATE_TABLE
statement ok
COPY all_types TO 'mssql://sqlsrv/dbo/all_types_test' (FORMAT 'bcp', CREATE_TABLE true);

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.all_types_test');
----
1

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.all_types_test');

statement ok
DROP TABLE all_types;

# Detach
statement ok
DETACH sqlsrv;
