# name: test/sql/copy/copy_catalog_target.test
# description: Test COPY TO MSSQL using catalog.schema.table syntax
# group: [copy]

require mssql

# Skip if no MSSQL server available
require-env MSSQL_TEST_DATABASE

statement ok
SET mssql_debug_level=1;

# Attach to SQL Server
statement ok
ATTACH '${MSSQL_TEST_DATABASE}' AS sqlsrv (TYPE mssql);

# Create a local table with test data
statement ok
CREATE TABLE local_data AS SELECT
    i AS id,
    'Name ' || i AS name,
    i * 1.5 AS value
FROM range(1, 51) t(i);

# ===========================================================================
# Test 1: COPY using catalog.schema.table syntax
# ===========================================================================

# First, create the target table on SQL Server
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_catalog_test');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_catalog_test (id int, name nvarchar(100), value float)');

# COPY data using catalog.schema.table syntax
statement ok
COPY local_data TO sqlsrv.dbo.copy_catalog_test (FORMAT 'bcp');

# Verify row count
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_catalog_test');
----
50

# Verify specific values
query II
SELECT id, name FROM mssql_scan('sqlsrv', 'SELECT id, name FROM dbo.copy_catalog_test WHERE id = 25');
----
25	Name 25

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_catalog_test');

# ===========================================================================
# Test 2: COPY using catalog.table syntax (default dbo schema)
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_default_schema');

statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE dbo.copy_default_schema (id int, name nvarchar(100), value float)');

# COPY using catalog.table (defaults to dbo schema)
statement ok
COPY local_data TO sqlsrv.copy_default_schema (FORMAT 'bcp');

# Verify
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_default_schema');
----
50

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_default_schema');

# ===========================================================================
# Test 3: COPY with CREATE_TABLE using catalog syntax
# ===========================================================================

statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_catalog_auto');

# COPY with CREATE_TABLE using catalog.schema.table syntax
statement ok
COPY local_data TO sqlsrv.dbo.copy_catalog_auto (FORMAT 'bcp', CREATE_TABLE true);

# Verify table was created and data was copied
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM dbo.copy_catalog_auto');
----
50

# Cleanup
statement ok
CALL mssql_exec('sqlsrv', 'DROP TABLE IF EXISTS dbo.copy_catalog_auto');

# ===========================================================================
# Test 4: Error case - Non-MSSQL catalog
# ===========================================================================

# Create a local DuckDB database
statement ok
ATTACH ':memory:' AS memdb;

# Try to COPY using bcp format to non-MSSQL catalog (should fail)
statement error
COPY local_data TO memdb.main.test_table (FORMAT 'bcp');
----
not an MSSQL catalog

# Detach the memory database
statement ok
DETACH memdb;

# ===========================================================================
# Test 5: Error case - Invalid catalog syntax
# ===========================================================================

statement error
COPY local_data TO 'invalid' (FORMAT 'bcp');
----
Invalid target format

# ===========================================================================
# Test 6: Catalog syntax with temp table in transaction
# ===========================================================================

statement ok
BEGIN TRANSACTION;

# Create temp table
statement ok
CALL mssql_exec('sqlsrv', 'CREATE TABLE #cat_temp (id int, name nvarchar(100), value float)');

# COPY to temp table using URL syntax (catalog syntax doesn't work well with # prefix parsing)
statement ok
COPY local_data TO 'mssql://sqlsrv/#cat_temp' (FORMAT 'bcp');

# Verify
query I
SELECT COUNT(*) FROM mssql_scan('sqlsrv', 'SELECT COUNT(*) FROM #cat_temp');
----
50

statement ok
COMMIT;

# Clean up local table
statement ok
DROP TABLE local_data;

# Detach
statement ok
DETACH sqlsrv;
