name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  # SQL Server test environment
  MSSQL_TEST_HOST: localhost
  MSSQL_TEST_PORT: 1433
  MSSQL_TEST_USER: sa
  MSSQL_TEST_PASS: TestPassword1
  MSSQL_TEST_DB: master

jobs:
  # ============================================================================
  # Lint Job - Check code formatting
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-14
          find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format-14 --dry-run --Werror

  # ============================================================================
  # Build Job - Build extension for Unix platforms
  # ============================================================================
  build:
    name: Build (${{ matrix.platform.id }})
    runs-on: ${{ matrix.platform.runner }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        platform:
          - id: linux_amd64
            os: linux
            arch: amd64
            runner: ubuntu-22.04
            docker_available: true

          - id: linux_arm64
            os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            docker_available: true

          - id: osx_arm64
            os: osx
            arch: arm64
            runner: macos-14
            docker_available: false

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        shell: bash
        run: |
          # Extract version from tag (v0.1.0 -> 0.1.0)
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $EXT_VERSION"

      - name: Checkout DuckDB submodule
        shell: bash
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        shell: bash
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "Extension Version: ${{ steps.version.outputs.ext_version }}"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: ${{ matrix.platform.id }}"
          echo "Runner: ${{ matrix.platform.runner }}"
          echo "============================================"

      - name: Setup Ninja and ccache
        run: |
          if [ "${{ matrix.platform.os }}" = "osx" ]; then
            brew install ninja ccache
          else
            sudo apt-get update
            sudo apt-get install -y ninja-build ccache
          fi

      # Cache ccache to speed up compilation
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.platform.id }}-${{ steps.duckdb.outputs.commit }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform.id }}-${{ steps.duckdb.outputs.commit }}-
            ccache-${{ matrix.platform.id }}-

      - name: Configure ccache
        shell: bash
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Setup vcpkg
        shell: bash
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.sh
          fi

      # Cache vcpkg installed packages
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
          key: vcpkg-${{ matrix.platform.id }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ matrix.platform.id }}-

      - name: Build Release
        run: |
          mkdir -p build/release
          cd build/release
          cmake -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_TOOLCHAIN_FILE="$(pwd)/../../vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_MANIFEST_DIR="$(pwd)/../.." \
            -DDUCKDB_EXTENSION_CONFIGS="$(pwd)/../../extension_config.cmake" \
            ../../duckdb
          cmake --build . --config Release

      - name: Show ccache stats
        shell: bash
        run: ccache -s

      - name: Rename artifact
        shell: bash
        run: |
          ARTIFACT_NAME="mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.platform.id }}.duckdb_extension"
          cp build/release/extension/mssql/mssql.duckdb_extension "$ARTIFACT_NAME"
          echo "Created artifact: $ARTIFACT_NAME"
          ls -la "$ARTIFACT_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.platform.id }}
          path: mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.platform.id }}.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.platform.id }}
          path: build/release/duckdb
          if-no-files-found: error

  # ============================================================================
  # Build Windows (MSVC) - Matches community-extensions CI configuration
  # ============================================================================
  build-windows-msvc:
    name: Build (windows_amd64)
    runs-on: windows-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $EXT_VERSION"

      - name: Checkout DuckDB submodule
        shell: bash
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        shell: bash
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "Extension Version: ${{ steps.version.outputs.ext_version }}"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: windows_amd64 (MSVC)"
          echo "vcpkg Triplet: x64-windows-static-release"
          echo "============================================"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '65604f5075c64b18a84c30de400def13aad2e0ec'

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
          key: vcpkg-windows-msvc-x64-windows-static-release-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-msvc-x64-windows-static-release-

      - name: Setup Visual Studio Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup ccache
        shell: bash
        run: |
          choco install ccache ninja
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/ccache
          key: ccache-windows_amd64-${{ steps.duckdb.outputs.commit }}-${{ github.sha }}
          restore-keys: |
            ccache-windows_amd64-${{ steps.duckdb.outputs.commit }}-
            ccache-windows_amd64-

      - name: Build Release
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build/release
          Push-Location build/release
          cmake -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DCMAKE_TOOLCHAIN_FILE="$env:RUNVCPKG_VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static-release `
            -DVCPKG_HOST_TRIPLET=x64-windows-static-release `
            -DVCPKG_MANIFEST_DIR="$(Get-Location)/../.." `
            -DDUCKDB_EXTENSION_CONFIGS="$(Get-Location)/../../extension_config.cmake" `
            ../../duckdb
          cmake --build . --config Release
          Pop-Location

      - name: Show ccache stats
        shell: bash
        run: ccache -s

      - name: Rename artifact
        shell: bash
        run: |
          ARTIFACT_NAME="mssql-${{ steps.version.outputs.ext_version }}-windows_amd64.duckdb_extension"
          cp build/release/extension/mssql/mssql.duckdb_extension "$ARTIFACT_NAME"
          echo "Created artifact: $ARTIFACT_NAME"
          ls -la "$ARTIFACT_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-windows_amd64
          path: mssql-${{ steps.version.outputs.ext_version }}-windows_amd64.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-windows_amd64
          path: build/release/duckdb.exe
          if-no-files-found: error

  # ============================================================================
  # Build Windows (MinGW) - Matches community-extensions CI configuration
  # ============================================================================
  build-windows-mingw:
    name: Build (windows_amd64_mingw)
    runs-on: windows-latest
    needs: lint
    env:
      CC: gcc
      CXX: g++

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $EXT_VERSION"

      - name: Checkout DuckDB submodule
        shell: bash
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        shell: bash
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "Extension Version: ${{ steps.version.outputs.ext_version }}"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: windows_amd64_mingw (MinGW)"
          echo "vcpkg Triplet: x64-mingw-static"
          echo "============================================"

      # Setup Rtools 4.2 for MinGW compiler
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'devel'
          update-rtools: true
          rtools-version: '42'

      - name: Setup rtools gcc for vcpkg
        shell: bash
        run: |
          cp C:/rtools42/x86_64-w64-mingw32.static.posix/bin/gcc.exe C:/rtools42/x86_64-w64-mingw32.static.posix/bin/x86_64-w64-mingw32-gcc.exe
          cp C:/rtools42/x86_64-w64-mingw32.static.posix/bin/g++.exe C:/rtools42/x86_64-w64-mingw32.static.posix/bin/x86_64-w64-mingw32-g++.exe
          echo "C:/rtools42/x86_64-w64-mingw32.static.posix/bin" >> $GITHUB_PATH
          echo "C:/rtools42/usr/bin" >> $GITHUB_PATH

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '65604f5075c64b18a84c30de400def13aad2e0ec'

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
          key: vcpkg-windows-mingw-x64-mingw-static-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-mingw-x64-mingw-static-

      - name: Setup ccache
        shell: bash
        run: |
          choco install ccache ninja
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/ccache
          key: ccache-windows_amd64_mingw-${{ steps.duckdb.outputs.commit }}-${{ github.sha }}
          restore-keys: |
            ccache-windows_amd64_mingw-${{ steps.duckdb.outputs.commit }}-
            ccache-windows_amd64_mingw-

      - name: Build Release
        shell: bash
        run: |
          mkdir -p build/release
          cd build/release
          cmake -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_TOOLCHAIN_FILE="$RUNVCPKG_VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-mingw-static \
            -DVCPKG_HOST_TRIPLET=x64-mingw-static \
            -DVCPKG_MANIFEST_DIR="$(pwd)/../.." \
            -DDUCKDB_EXTENSION_CONFIGS="$(pwd)/../../extension_config.cmake" \
            ../../duckdb
          cmake --build . --config Release

      - name: Show ccache stats
        shell: bash
        run: ccache -s

      - name: Rename artifact
        shell: bash
        run: |
          ARTIFACT_NAME="mssql-${{ steps.version.outputs.ext_version }}-windows_amd64_mingw.duckdb_extension"
          cp build/release/extension/mssql/mssql.duckdb_extension "$ARTIFACT_NAME"
          echo "Created artifact: $ARTIFACT_NAME"
          ls -la "$ARTIFACT_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-windows_amd64_mingw
          path: mssql-${{ steps.version.outputs.ext_version }}-windows_amd64_mingw.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-windows_amd64_mingw
          path: build/release/duckdb.exe
          if-no-files-found: error

  # ============================================================================
  # Smoke Test Job - Verify extension loads correctly (Unix)
  # ============================================================================
  smoke-test:
    name: Smoke Test (${{ matrix.platform.id }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        platform:
          - id: linux_amd64
            os: linux
            arch: amd64
            runner: ubuntu-22.04
            docker_available: true

          - id: linux_arm64
            os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            docker_available: true

          - id: osx_arm64
            os: osx
            arch: arm64
            runner: macos-14
            docker_available: false

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.platform.id }}
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.platform.id }}
          path: cli

      - name: Setup executables
        run: chmod +x cli/duckdb

      - name: Rename extension for loading
        shell: bash
        run: |
          # DuckDB derives extension name from filename - must be named mssql.duckdb_extension
          VERSIONED_FILE="extension/mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.platform.id }}.duckdb_extension"
          mv "$VERSIONED_FILE" extension/mssql.duckdb_extension
          ls -la extension/

      - name: Run load-only smoke test
        run: |
          chmod +x scripts/ci/smoke_test.sh
          scripts/ci/smoke_test.sh ./cli/duckdb extension/mssql.duckdb_extension

  # ============================================================================
  # Smoke Test Job - Windows (MSVC and MinGW)
  # ============================================================================
  smoke-test-windows:
    name: Smoke Test (${{ matrix.config.id }})
    runs-on: windows-latest
    needs: [build-windows-msvc, build-windows-mingw]
    strategy:
      fail-fast: false
      matrix:
        config:
          - id: windows_amd64
            artifact_suffix: windows_amd64
          - id: windows_amd64_mingw
            artifact_suffix: windows_amd64_mingw

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.config.artifact_suffix }}
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.config.artifact_suffix }}
          path: cli

      - name: Rename extension for loading
        shell: bash
        run: |
          VERSIONED_FILE="extension/mssql-${{ steps.version.outputs.ext_version }}-${{ matrix.config.artifact_suffix }}.duckdb_extension"
          mv "$VERSIONED_FILE" extension/mssql.duckdb_extension
          ls -la extension/

      - name: Run load-only smoke test
        shell: pwsh
        run: |
          .\cli\duckdb.exe --unsigned -c "LOAD 'extension/mssql.duckdb_extension'; SELECT mssql_version();"

  # ============================================================================
  # Integration Test Job - Full SQL Server tests on Linux x64 only
  # (SQL Server Docker image doesn't support ARM64)
  # ============================================================================
  integration-test:
    name: Integration Test (linux_amd64)
    runs-on: ubuntu-22.04
    needs: smoke-test

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: TestPassword1
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword1 -C -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-${{ steps.version.outputs.ext_version }}-linux_amd64
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-linux_amd64
          path: cli

      - name: Setup executables
        run: |
          chmod +x cli/duckdb
          chmod +x scripts/ci/integration_test.sh

      - name: Rename extension for loading
        run: |
          # DuckDB derives extension name from filename - must be named mssql.duckdb_extension
          VERSIONED_FILE="extension/mssql-${{ steps.version.outputs.ext_version }}-linux_amd64.duckdb_extension"
          mv "$VERSIONED_FILE" extension/mssql.duckdb_extension
          ls -la extension/

      - name: Wait for SQL Server
        run: |
          echo "Waiting for SQL Server to be ready..."
          timeout 120 bash -c 'until echo > /dev/tcp/localhost/1433 2>/dev/null; do sleep 5; done'
          echo "SQL Server is ready!"

      - name: Run integration tests
        run: |
          scripts/ci/integration_test.sh ./cli/duckdb extension/mssql.duckdb_extension

  # ============================================================================
  # Release Job - Collect artifacts and publish to GitHub Release
  # ============================================================================
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [smoke-test, smoke-test-windows, integration-test]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract extension version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          EXT_VERSION="${TAG#v}"
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect and rename artifacts
        run: |
          mkdir -p release
          find artifacts -name "*.duckdb_extension" -exec cp {} release/ \;
          ls -la release/

      - name: Generate SHA256 checksums
        run: |
          cd release
          sha256sum *.duckdb_extension > SHA256SUMS.txt
          echo "=== SHA256SUMS.txt ==="
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          files: |
            release/*.duckdb_extension
            release/SHA256SUMS.txt
          fail_on_unmatched_files: true
          body: |
            ## MSSQL Extension ${{ steps.version.outputs.tag }}

            Built against DuckDB v1.5 (variegata).

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | Linux x64 | `mssql-${{ steps.version.outputs.ext_version }}-linux_amd64.duckdb_extension` |
            | Linux ARM64 | `mssql-${{ steps.version.outputs.ext_version }}-linux_arm64.duckdb_extension` |
            | macOS ARM64 | `mssql-${{ steps.version.outputs.ext_version }}-osx_arm64.duckdb_extension` |
            | Windows x64 (MSVC) | `mssql-${{ steps.version.outputs.ext_version }}-windows_amd64.duckdb_extension` |
            | Windows x64 (MinGW) | `mssql-${{ steps.version.outputs.ext_version }}-windows_amd64_mingw.duckdb_extension` |

            ### Verification

            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Installation

            ```sql
            INSTALL 'path/to/mssql-${{ steps.version.outputs.ext_version }}-<PLATFORM>.duckdb_extension';
            LOAD mssql;
            ```
