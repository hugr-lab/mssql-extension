name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_build:
        description: 'Run build and tests'
        required: false
        default: false
        type: boolean
      run_integration_tests:
        description: 'Run SQL Server integration tests (requires run_build)'
        required: false
        default: true
        type: boolean
      run_windows_build:
        description: 'Run Windows builds (MSVC and MinGW)'
        required: false
        default: false
        type: boolean
      run_azure_tests:
        description: 'Run Azure SQL/Fabric tests (requires run_build, use on feature branches only)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # SQL Server test environment
  MSSQL_TEST_HOST: localhost
  MSSQL_TEST_PORT: 1433
  MSSQL_TEST_USER: sa
  MSSQL_TEST_PASS: TestPassword1
  MSSQL_TEST_DB: master

jobs:
  # ============================================================================
  # Lint Job - Check code formatting (runs on merge to main)
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-14
          find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format-14 --dry-run --Werror

  # ============================================================================
  # Build Job - Build against DuckDB stable on representative platforms
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  build:
    name: Build (${{ matrix.platform.id }})
    runs-on: ${{ matrix.platform.runner }}
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_build }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux x86_64 - with Docker support for integration tests
          - id: linux_amd64
            os: linux
            arch: amd64
            runner: ubuntu-22.04
            docker_available: true
            vcpkg_triplet: x64-linux

          # macOS ARM64 - load-only testing
          - id: osx_arm64
            os: osx
            arch: arm64
            runner: macos-14
            docker_available: false
            vcpkg_triplet: arm64-osx

    steps:
      - uses: actions/checkout@v4

      - name: Checkout DuckDB submodule
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          DUCKDB_BRANCH=$(git -C duckdb branch --show-current 2>/dev/null || git config -f .gitmodules submodule.duckdb.branch 2>/dev/null || echo "unknown")
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "DuckDB Branch: $DUCKDB_BRANCH"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: ${{ matrix.platform.id }}"
          echo "Runner: ${{ matrix.platform.runner }}"
          echo "============================================"

      - name: Setup Ninja
        run: |
          if [ "${{ matrix.platform.os }}" = "osx" ]; then
            brew install ninja ccache
          else
            sudo apt-get update
            sudo apt-get install -y ninja-build ccache
          fi

      # Cache ccache to speed up compilation
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.platform.id }}-${{ steps.duckdb.outputs.commit }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform.id }}-${{ steps.duckdb.outputs.commit }}-
            ccache-${{ matrix.platform.id }}-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Setup vcpkg
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
            ./vcpkg/bootstrap-vcpkg.sh
          fi

      # Cache vcpkg installed packages
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
            vcpkg/buildtrees
          key: vcpkg-${{ matrix.platform.vcpkg_triplet }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ matrix.platform.vcpkg_triplet }}-

      - name: Build Release
        env:
          CMAKE_C_COMPILER_LAUNCHER: ccache
          CMAKE_CXX_COMPILER_LAUNCHER: ccache
        run: |
          mkdir -p build/release
          cd build/release
          cmake -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_TOOLCHAIN_FILE="$(pwd)/../../vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_MANIFEST_DIR="$(pwd)/../.." \
            -DDUCKDB_EXTENSION_CONFIGS="$(pwd)/../../extension_config.cmake" \
            ../../duckdb
          cmake --build . --config Release

      - name: Show ccache stats
        run: ccache -s

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-extension-${{ matrix.platform.id }}
          path: build/release/extension/mssql/mssql.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.platform.id }}
          path: build/release/duckdb
          if-no-files-found: error

      - name: Upload unittest Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unittest-${{ matrix.platform.id }}
          path: build/release/test/unittest
          if-no-files-found: error

      - name: Upload libduckdb Artifact (for unittest)
        uses: actions/upload-artifact@v4
        with:
          name: libduckdb-${{ matrix.platform.id }}
          path: |
            build/release/src/libduckdb.so
            build/release/src/libduckdb.dylib
          if-no-files-found: warn

  # ============================================================================
  # Smoke Test Job - Load-only test on all platforms
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  smoke-test:
    name: Smoke Test (${{ matrix.platform.id }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_build }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - id: linux_amd64
            os: linux
            runner: ubuntu-22.04
            docker_available: true

          - id: osx_arm64
            os: osx
            runner: macos-14
            docker_available: false

    steps:
      - uses: actions/checkout@v4

      - name: Download extension artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-extension-${{ matrix.platform.id }}
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.platform.id }}
          path: cli

      - name: Setup executables
        run: |
          chmod +x cli/duckdb
          chmod +x scripts/ci/smoke_test.sh

      - name: Run load-only smoke test
        run: |
          scripts/ci/smoke_test.sh ./cli/duckdb ./extension/mssql.duckdb_extension

      - name: Log integration test status (non-Linux)
        if: matrix.platform.docker_available == false
        run: |
          echo "============================================"
          echo "Integration test skipped - Docker not available on ${{ matrix.platform.id }}"
          echo "Load-only smoke test passed successfully"
          echo "============================================"

  # ============================================================================
  # Integration Test Job - SQL Server tests on Linux only
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  integration-test:
    name: Integration Test (linux_amd64)
    runs-on: ubuntu-22.04
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_build && inputs.run_integration_tests }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: TestPassword1
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword1 -C -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - uses: actions/checkout@v4

      - name: Download extension artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-extension-linux_amd64
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-linux_amd64
          path: cli

      - name: Setup executables
        run: |
          chmod +x cli/duckdb
          chmod +x scripts/ci/integration_test.sh

      - name: Wait for SQL Server
        run: |
          echo "Waiting for SQL Server to be ready..."
          timeout 120 bash -c 'until echo > /dev/tcp/localhost/1433 2>/dev/null; do sleep 5; done'
          echo "SQL Server is ready!"

      - name: Run integration tests
        run: |
          scripts/ci/integration_test.sh ./cli/duckdb ./extension/mssql.duckdb_extension

  # ============================================================================
  # Windows Build Job - MSVC (Visual Studio 2022)
  # Matches community-extensions CI configuration
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  build-windows-msvc:
    name: Build Windows (MSVC)
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_windows_build }}

    steps:
      - uses: actions/checkout@v4

      - name: Checkout DuckDB submodule
        shell: bash
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        shell: bash
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: windows_amd64 (MSVC)"
          echo "vcpkg Triplet: x64-windows-static-md-release-vs2019comp (matches community-extensions CI)"
          echo "============================================"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '65604f5075c64b18a84c30de400def13aad2e0ec'

      # Cache vcpkg installed packages
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
          key: vcpkg-windows-msvc-x64-windows-static-md-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-msvc-x64-windows-static-md-

      - name: Setup Visual Studio Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Release
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build/release
          Push-Location build/release
          cmake -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:RUNVCPKG_VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static-md-release-vs2019comp `
            -DVCPKG_HOST_TRIPLET=x64-windows-static-md-release-vs2019comp `
            -DVCPKG_OVERLAY_TRIPLETS="$(Get-Location)/../../toolchains" `
            -DVCPKG_MANIFEST_DIR="$(Get-Location)/../.." `
            -DDUCKDB_EXTENSION_CONFIGS="$(Get-Location)/../../extension_config.cmake" `
            ../../duckdb
          cmake --build . --config Release
          Pop-Location

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-extension-windows_amd64_msvc
          path: build/release/extension/mssql/mssql.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-windows_amd64_msvc
          path: build/release/duckdb.exe
          if-no-files-found: error

  # ============================================================================
  # Windows Build Job - MinGW (Rtools 4.2)
  # Matches community-extensions CI configuration
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  build-windows-mingw:
    name: Build Windows (MinGW)
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_windows_build }}
    env:
      CC: gcc
      CXX: g++

    steps:
      - uses: actions/checkout@v4

      - name: Checkout DuckDB submodule
        shell: bash
        run: |
          git submodule update --init --recursive duckdb

      - name: Log build metadata
        id: duckdb
        shell: bash
        run: |
          DUCKDB_COMMIT=$(git -C duckdb rev-parse HEAD)
          echo "commit=$DUCKDB_COMMIT" >> $GITHUB_OUTPUT
          echo "============================================"
          echo "Build Metadata"
          echo "============================================"
          echo "DuckDB Commit: $DUCKDB_COMMIT"
          echo "Platform: windows_amd64 (MinGW)"
          echo "vcpkg Triplet: x64-mingw-static"
          echo "============================================"

      # Setup Rtools 4.2 for MinGW compiler
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'devel'
          update-rtools: true
          rtools-version: '42'

      - name: Setup rtools gcc for vcpkg
        shell: bash
        run: |
          cp C:/rtools42/x86_64-w64-mingw32.static.posix/bin/gcc.exe C:/rtools42/x86_64-w64-mingw32.static.posix/bin/x86_64-w64-mingw32-gcc.exe
          cp C:/rtools42/x86_64-w64-mingw32.static.posix/bin/g++.exe C:/rtools42/x86_64-w64-mingw32.static.posix/bin/x86_64-w64-mingw32-g++.exe
          echo "C:/rtools42/x86_64-w64-mingw32.static.posix/bin" >> $GITHUB_PATH
          echo "C:/rtools42/usr/bin" >> $GITHUB_PATH

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '65604f5075c64b18a84c30de400def13aad2e0ec'

      # Cache vcpkg installed packages
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
          key: vcpkg-windows-mingw-x64-mingw-static-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-mingw-x64-mingw-static-

      - name: Build Release
        shell: bash
        run: |
          mkdir -p build/release
          cd build/release
          cmake -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_TOOLCHAIN_FILE="$RUNVCPKG_VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-mingw-static \
            -DVCPKG_HOST_TRIPLET=x64-mingw-static \
            -DVCPKG_MANIFEST_DIR="$(pwd)/../.." \
            -DDUCKDB_EXTENSION_CONFIGS="$(pwd)/../../extension_config.cmake" \
            ../../duckdb
          cmake --build . --config Release

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mssql-extension-windows_amd64_mingw
          path: build/release/extension/mssql/mssql.duckdb_extension
          if-no-files-found: error

      - name: Upload DuckDB CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-cli-windows_amd64_mingw
          path: build/release/duckdb.exe
          if-no-files-found: error

  # ============================================================================
  # Windows Smoke Test Job - Verify extension loads on Windows
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  smoke-test-windows:
    name: Smoke Test Windows (${{ matrix.config.name }})
    runs-on: windows-latest
    needs: [build-windows-msvc, build-windows-mingw]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_windows_build }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: MSVC
            artifact_suffix: windows_amd64_msvc
          - name: MinGW
            artifact_suffix: windows_amd64_mingw

    steps:
      - uses: actions/checkout@v4

      - name: Download extension artifact
        uses: actions/download-artifact@v4
        with:
          name: mssql-extension-${{ matrix.config.artifact_suffix }}
          path: extension

      - name: Download DuckDB CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: duckdb-cli-${{ matrix.config.artifact_suffix }}
          path: cli

      - name: Run load-only smoke test
        shell: bash
        run: |
          echo "Testing extension load for ${{ matrix.config.name }} build..."
          ./cli/duckdb.exe -unsigned -c "LOAD 'extension/mssql.duckdb_extension'; SELECT mssql_version();"
          echo "Smoke test passed!"

  # ============================================================================
  # Azure Test Job - Azure SQL Database and Fabric tests
  # Uses 'test' environment for secrets (AZURE_APP_ID, AZURE_APP_SECRET, etc.)
  # Runs DuckDB unittest with [azure] test group
  # (Manual trigger only via workflow_dispatch)
  # ============================================================================
  azure-test:
    name: Azure Test (linux_amd64)
    runs-on: ubuntu-22.04
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_build && inputs.run_azure_tests && github.ref != 'refs/heads/main' }}
    environment: test

    steps:
      - uses: actions/checkout@v4

      - name: Download unittest artifact
        uses: actions/download-artifact@v4
        with:
          name: unittest-linux_amd64
          path: test

      - name: Download libduckdb artifact
        uses: actions/download-artifact@v4
        with:
          name: libduckdb-linux_amd64
          path: lib

      - name: Setup executables
        run: |
          chmod +x test/unittest

      - name: Run Azure tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/lib
          AZURE_SQL_TEST_DSN: ${{ secrets.AZURE_SQL_TEST_DSN }}
          AZURE_APP_ID: ${{ secrets.AZURE_APP_ID }}
          AZURE_DIRECTORY_ID: ${{ secrets.AZURE_DIRECTORY_ID }}
          AZURE_APP_SECRET: ${{ secrets.AZURE_APP_SECRET }}
          AZURE_SQL_DB_HOST: ${{ secrets.AZURE_SQL_DB_HOST }}
          AZURE_SQL_DB: ${{ secrets.AZURE_SQL_DB }}
        run: |
          echo "============================================"
          echo "Running Azure Tests with unittest"
          echo "============================================"
          echo "AZURE_APP_ID is set: $([ -n \"$AZURE_APP_ID\" ] && echo 'yes' || echo 'no')"
          echo "AZURE_DIRECTORY_ID is set: $([ -n \"$AZURE_DIRECTORY_ID\" ] && echo 'yes' || echo 'no')"
          echo "AZURE_APP_SECRET is set: $([ -n \"$AZURE_APP_SECRET\" ] && echo 'yes' || echo 'no')"
          echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
          echo "============================================"

          # Run Azure test group
          ./test/unittest "[azure]" --force-reload

          echo "Azure tests completed!"
